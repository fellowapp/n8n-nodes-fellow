name: Publish Production Package

on:
  release:
    types: [published]

jobs:
  publish-prod:
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # 6.0.1
        with:
          fetch-depth: 0

      - name: Install flox
        uses: flox/install-flox-action@819183ecd53757be53d66f492eeb7d689687a66b # 2.1.0

      - name: Install dependencies
        run: flox activate -- pnpm install --frozen-lockfile

      - name: Build Production Package
        run: flox activate -- pnpm run build:prod

      - name: Get version from release tag
        id: release_version
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: |
          # Remove 'v' prefix if present (v0.1.0 -> 0.1.0)
          VERSION="${RELEASE_TAG#v}"

          # Validate version format (semantic versioning with optional prerelease/build metadata)
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$ ]]; then
            echo "Error: Invalid version format: $VERSION"
            echo "Expected semantic versioning format (e.g., 1.0.0, 1.0.0-beta.1, 1.0.0+build.123)"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update package.json version
        run: flox activate -- pnpm version ${{ steps.release_version.outputs.version }} --no-git-tag-version --allow-same-version

      - name: Publish Production Package (@fellowapp/n8n-nodes-fellow)
        run: flox activate -- pnpm publish --access restricted --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Revert package.json changes
        run: git checkout -- package.json
