name: Update Internal n8n Node Version

on:
  workflow_run:
    workflows: ['Publish Staging Package']
    types:
      - completed
    branches:
      - main

jobs:
  update-version:
    runs-on: ubuntu-latest
    environment: staging
    # Only run if the publish workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: read
    steps:
      - name: Checkout n8n-nodes-fellow repo
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # 6.0.1
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0
          fetch-tags: true

      - name: Get latest version from git tags
        id: package_version
        run: |
          # Get all tags, filter for semantic versions (with or without 'v' prefix), sort, get latest
          LATEST_TAG=$(git tag -l | grep -E '^v?[0-9]+\.[0-9]+\.[0-9]+' | sed 's/^v//' | sort -V | tail -n 1)
          # Default to 0.1.0 if no tags found
          VERSION=${LATEST_TAG:-0.1.0}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Using version: $VERSION"

      - name: Get short SHA
        id: sha
        run: echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Create staging version string
        id: staging_version
        run: echo "version_string=${{ steps.package_version.outputs.version }}-main.${{ steps.sha.outputs.short_sha }}-staging" >> $GITHUB_OUTPUT

      - name: Checkout ops-workflow-builder repo
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # 6.0.1
        with:
          repository: fellowapp/ops-workflow-builder
          token: ${{ secrets.OPS_WORKFLOW_BUILDER_PAT }}
          path: ops-workflow-builder

      - name: Update fellowNodeVersion in values.yaml
        run: |
          cd ops-workflow-builder
          sed -i.bak "s/fellowNodeVersion: .*/fellowNodeVersion: ${{ steps.staging_version.outputs.version_string }}/" deploy/ops-workflow-builder/values.yaml
          rm deploy/ops-workflow-builder/values.yaml.bak
        shell: bash

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@22a9089034f40e5a961c8808d113e2c98fb63676 # v7
        with:
          token: ${{ secrets.OPS_WORKFLOW_BUILDER_PAT }}
          path: ops-workflow-builder
          commit-message: |
            Update n8n Fellow node to ${{ steps.staging_version.outputs.version_string }}

            Auto-generated PR to update Fellow n8n node staging version.

            Source commit: ${{ github.sha }}
          branch: auto-update-fellow-node-${{ steps.sha.outputs.short_sha }}
          delete-branch: true
          title: 'Update Fellow n8n node to ${{ steps.staging_version.outputs.version_string }}'
          body: |
            ## Automated n8n Node Version Update

            This PR updates the Fellow n8n node staging version to `${{ steps.staging_version.outputs.version_string }}`.

            **Changes:**
            - Updates `fellowNodeVersion` in `deploy/ops-workflow-builder/values.yaml`

            **Source:**
            - Repository: `fellowapp/n8n-nodes-fellow`
            - Commit: `${{ github.event.workflow_run.head_sha }}`
            - Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ---
            ðŸ¤– This PR was automatically generated by the `update-ops-workflow-builder` workflow.
          labels: |
            automated
            n8n
            staging
